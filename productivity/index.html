
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Productivity</title>
  <style>
    body { font-family: 'Sarabun', sans-serif; max-width: 1000px; margin: 2rem auto; }
    h2 { font-family: 'Prompt', sans-serif; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; table-layout: fixed; }
    th, td { padding: 0.5rem; border: 1px solid #ccc; vertical-align: top; }
    td input[type="text"], td input[type="number"], td select, textarea { width: 100%; padding: 0.4rem; box-sizing: border-box; }
    input[type="date"] { padding: 0.4rem; }
    button { padding: 0.5rem 1rem; margin: 0.5rem 0; }
    .flatpickr-calendar { z-index: 99999 !important; visibility: visible !important; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@600&family=Sarabun&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
</head>
<body>
<h2>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° Productivity ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
<a href="view_edit.html" target="_blank"><button type="button">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button></a>
<form id="productivity-form">
  <div style="display: flex; gap: 1rem; align-items: flex-start; margin-bottom: 1rem;">
    <div style="flex: 1;">
      <label for="name">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</label><br>
      <input type="text" name="name" id="name" required>
    </div>
    <div style="flex: 1;">
      <label for="department">‡∏ù‡πà‡∏≤‡∏¢:</label><br>
      <input type="text" name="department" id="department" required>
    </div>
    <div style="flex: 1;">
      <label for="unit">‡∏á‡∏≤‡∏ô:</label><br>
      <input type="text" name="unit" id="unit" required>
    </div>
    <div style="flex: 1;">
      <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å:</label><br>
      <input type="text" id="date" name="date" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" required>
    </div>
  </div>
  <div style="flex: 1;">
    <label for="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô):</label><br>
    <select name="month" id="month" required>
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô --</option>
      <option value="2025-01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2025</option>
      <option value="2025-02">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2025</option>
      <option value="2025-03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2025</option>
      <option value="2025-04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô 2025</option>
      <option value="2025-05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏° 2025</option>
      <option value="2025-06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô 2025</option>
      <option value="2025-07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2025</option>
      <option value="2025-08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏° 2025</option>
      <option value="2025-09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2025</option>
      <option value="2025-10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° 2025</option>
      <option value="2025-11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô 2025</option>
      <option value="2025-12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2025</option>
    </select>
  </div><br>
  <table id="task-table">
    <thead><tr>
      <th style="width: 20%">Key Project</th>
      <th style="width: 22%">Key Activity</th>
      <th style="width: 28%">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
      <th>Man day</th>
      <th>‡∏•‡∏ö</th>
    </tr></thead>
    <tbody id="task-body"></tbody>
  </table>
  <button type="button" onclick="addRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button><br>
  <button type="button" onclick="previewData()">Preview ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</button>
  <p id="submit-message" style="color: green; font-weight: bold;"></p>
</form>
<div id="preview-screen" style="display: none; margin-top: 2rem;">
  <h3>üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</h3>
  <div id="preview-content"></div>
  <button onclick="confirmSubmit()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <button onclick="cancelPreview()">üîÑ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
</div>
<script>
function addRow() {
  const tbody = document.getElementById('task-body');
  const rowId = Date.now();
  const row = document.createElement('tr');
  const keyProjectOptions = ["Y1 Engagement", "Y2 Career Development"].map(k => `<option value="${k}">${k}</option>`).join('');
  row.innerHTML = `
    <td><select name="key_project[]" onchange="updateActivities(this, 'activity-${rowId}')" required><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Key Project --</option>${keyProjectOptions}</select></td>
    <td><select name="key_activity[]" id="activity-${rowId}" required><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Key Activity --</option></select></td>
    <td><textarea name="detail[]" rows="3" required></textarea></td>
    <td><input type="number" name="manday[]" step="0.01" min="0" required></td>
    <td><button type="button" onclick="this.closest('tr').remove()">‡∏•‡∏ö</button></td>`;
  tbody.appendChild(row);
}
function updateActivities(selectEl, activitySelectId) {
  const selected = selectEl.value;
  const activityMap = {
    "Y1 Engagement": ["Y1-1 Survey Engagement", "Y1-2 Engagement Plan"],
    "Y2 Career Development": ["Y2-1 Competency", "Y2-2 Language Training"]
  };
  const activitySelect = document.getElementById(activitySelectId);
  activitySelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Key Activity --</option>';
  if (activityMap[selected]) {
    activityMap[selected].forEach(act => {
      const opt = document.createElement('option');
      opt.value = act;
      opt.textContent = act;
      activitySelect.appendChild(opt);
    });
  }
}
document.addEventListener('DOMContentLoaded', function() {
  addRow();
  flatpickr("#date", { dateFormat: "d/m/Y", locale: "th", defaultDate: "today", disableMobile: true });
});
function previewData() {
  const formData = new FormData(document.getElementById('productivity-form'));
  const keyProjects = [...document.querySelectorAll('select[name="key_project[]"]')].map(el => el.value);
  const keyActivities = [...document.querySelectorAll('select[name="key_activity[]"]')].map(el => el.value);
  const details = formData.getAll('detail[]');
  const mandays = formData.getAll('manday[]');
  let html = "<table border='1'><thead><tr><th>Key Project</th><th>Key Activity</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>Man Day</th></tr></thead><tbody>";
  for (let i = 0; i < keyProjects.length; i++) {
    html += `<tr><td>${keyProjects[i]}</td><td>${keyActivities[i]}</td><td>${details[i]}</td><td>${mandays[i]}</td></tr>`;
  }
  html += "</tbody></table>";
  document.getElementById('preview-content').innerHTML = html;
  document.getElementById('productivity-form').style.display = 'none';
  document.getElementById('preview-screen').style.display = 'block';
}
function cancelPreview() {
  document.getElementById('preview-screen').style.display = 'none';
  document.getElementById('productivity-form').style.display = 'block';
}
async function confirmSubmit() {
  const formData = new FormData(document.getElementById('productivity-form'));
  const name = formData.get('name');
  const department = formData.get('department');
  const unit = formData.get('unit');
  const date = formData.get('date');
  const month = formData.get('month');
  const keyProjects = [...document.querySelectorAll('select[name="key_project[]"]')].map(el => el.value);
  const keyActivities = [...document.querySelectorAll('select[name="key_activity[]"]')].map(el => el.value);
  const details = formData.getAll('detail[]');
  const mandays = formData.getAll('manday[]');
  const payload = keyProjects.map((kp, i) => ({
    date, month, name, department, unit,
    key_project: kp,
    key_activity: keyActivities[i],
    detail: details[i],
    man_day: parseFloat(mandays[i])
  }));
  try {
    await fetch('https://olalarna.app.n8n.cloud/webhook/productivity-log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    document.getElementById("submit-message").innerText = "‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
    document.getElementById('productivity-form').reset();
    document.getElementById('task-body').innerHTML = '';
    cancelPreview();
    addRow();
  } catch (error) {
    console.error("‚ùå Error:", error);
    document.getElementById("submit-message").innerText = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  }
}
</script>
</body>
</html>
