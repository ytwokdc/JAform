<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <title>Job Analysis form</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f5f7fa;
            padding: 30px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            color: #2196F3;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 30px;
        }
        
        .header-section {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .form-section {
            flex: 1;
        }
        
        .control-section {
            width: 300px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Prompt', sans-serif;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'Prompt', sans-serif;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-import {
            background-color: #22c55e;
            color: white;
        }
        
        .btn-export {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
            width: 160px;
        }
        
        .btn-success {
            background-color: #2196F3;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            width: 160px;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            width: 160px;
        }
        
        .btn-warning {
            background-color: #fbbf24;
            color: #333;
            padding: 6px 12px;
            font-size: 13px;
        }
        
        .btn-person-add {
            background-color: #2196F3;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
            width: 100px;
        }
        
        .btn-person-delete {
            background-color: #ef4444;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
            width: 100px;
        }
        
        .task-item {
            background-color: #e7f3fe;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .task-number {
            position: absolute;
            left: -15px;
            top: 20px;
            background-color: #2196F3;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
        }
        
        .task-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .task-field {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
        }
        
        .task-field label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }
        
        .task-field textarea, .process-field textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-family: 'Prompt', sans-serif;
        }
        
        .process-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .process-field {
            margin-bottom: 15px;
        }
        
        .process-field label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }
        
        .person-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .person-row input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Prompt', sans-serif;
        }
        
        .person-row input[type="text"] {
            flex: 2;
        }
        
        .person-row input[type="number"] {
            width: 60px;
            text-align: center;
        }
        
        .person-row .quantity-input {
            width: 60px;
        }
        
        .person-row .unit-input {
            width: 100px;
        }
        
        .summary-box {
            background-color: white;
            border: 2px solid #22c55e;
            border-radius: 12px;
            padding: 15px 25px;
            min-width: 250px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .summary-box.total {
            border-color: #2196F3;
        }
        
        .summary-box .summary-title {
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .person-summary-wrapper {
            max-height: 120px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .person-summary-wrapper::-webkit-scrollbar {
            width: 8px;
        }
        
        .person-summary-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .person-summary-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .person-summary-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .person-summary-item {
            padding: 2px 0;
            line-height: 1.5;
        }
        
        #fileInput {
            display: none;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .time-display {
            margin-top: 10px;
            text-align: right;
        }
        
        .sum-time-display {
            font-size: 16px;
            color: #166534;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .total-time-display {
            font-size: 16px;
            color: #2196F3;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Job Analysis form</h1>
        
        <div class="header-section">
            <div class="form-section">
                <div class="form-group">
                    <label for="department">ฝ่าย</label>
                    <input type="text" id="department" name="department" required>
                </div>
                
                <div class="form-group">
                    <label for="job">งาน</label>
                    <input type="text" id="job" name="job" required>
                </div>
                
                <div class="form-group">
                    <label for="informant">ผู้ให้ข้อมูล</label>
                    <input type="text" id="informant" name="informant" required>
                </div>
            </div>
            
            <div class="control-section">
                <input type="file" id="fileInput" accept=".xlsx, .xls">
                <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">
                    Import from Excel
                </button>
                <button class="btn btn-export" onclick="exportToExcel()">
                    Export to Excel
                </button>
                
                <div class="summary-box">
                    <div class="summary-title">เวลารวมตามรายชื่อ</div>
                    <div class="person-summary-wrapper">
                        <div id="person-summary-content"></div>
                    </div>
                </div>
                
                <div class="summary-box total">
                    <div>เวลารวมทั้งสิ้น</div>
                    <div id="total-summary-value">0 วันทำการ 0 ชม. 0 นาที</div>
                </div>
            </div>
        </div>
        
        <div id="taskContainer"></div>
        
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="addNewTask()">เพิ่มภารกิจ</button>
            <button class="btn btn-danger" onclick="deleteAllTasks()">ลบภารกิจ</button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    // Global variables
    let taskCount = 0;
    let processCount = 0;
    
    // Add new task
    function addNewTask() {
        taskCount++;
        const taskContainer = document.getElementById('taskContainer');
        
        const taskDiv = document.createElement('div');
        taskDiv.className = 'task-item';
        taskDiv.setAttribute('data-task-id', taskCount);
        taskDiv.innerHTML = `
            <div class="task-number">${taskCount}</div>
            <div class="task-content">
                <div class="task-field">
                    <label>บทบาทหน้าที่/ภารกิจหน่วยงาน</label>
                    <textarea name="role" required></textarea>
                </div>
                <div class="task-field">
                    <label>สิ่งที่ส่งมอบ</label>
                    <textarea name="deliverable" required></textarea>
                </div>
                <div class="task-field">
                    <label>โครงการ/กิจกรรม</label>
                    <textarea name="project" required></textarea>
                </div>
            </div>
            <div class="process-container"></div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="addProcess(this)">เพิ่มกระบวนการ</button>
            </div>
        `;
        
        taskContainer.appendChild(taskDiv);
        addProcess(taskDiv.querySelector('.btn-success'));
    }
    
    // Delete all tasks
    function deleteAllTasks() {
        const taskContainer = document.getElementById('taskContainer');
        const tasks = taskContainer.querySelectorAll('.task-item');
        
        if (tasks.length > 1) {
            if (confirm('ต้องการลบภารกิจสุดท้ายใช่หรือไม่?')) {
                const lastTask = tasks[tasks.length - 1];
                lastTask.remove();
                taskCount = tasks.length - 1;
                calculateTotal();
            }
        } else {
            alert('ต้องมีภารกิจอย่างน้อย 1 ภารกิจ');
        }
    }
    
    // Add process to task
    function addProcess(btn) {
        processCount++;
        const taskDiv = btn.closest('.task-item');
        const processContainer = taskDiv.querySelector('.process-container');
        
        const processDiv = document.createElement('div');
        processDiv.className = 'process-section';
        processDiv.innerHTML = `
            <div class="process-field">
                <label>กระบวนการ/ขั้นตอน</label>
                <textarea name="process" required></textarea>
            </div>
            <div class="person-container"></div>
            <div class="time-display">
                <div class="sum-time-display">เวลารวม/หน่วย: <span class="sum-time">0 ชม. 0 นาที</span></div>
                <div class="total-time-display">เวลารวมของการทำกิจกรรม: <span class="total-time">0 ชม. 0 นาที</span></div>
            </div>
        `;
        
        processContainer.appendChild(processDiv);
        
        // Update action buttons to include delete process button
        const actionButtons = taskDiv.querySelector('.action-buttons');
        if (processContainer.children.length > 1 && !actionButtons.querySelector('.btn-delete-process')) {
            const deleteProcessBtn = document.createElement('button');
            deleteProcessBtn.className = 'btn btn-danger btn-delete-process';
            deleteProcessBtn.textContent = 'ลบกระบวนการ';
            deleteProcessBtn.onclick = function() { deleteProcess(this); };
            actionButtons.insertBefore(deleteProcessBtn, actionButtons.querySelector('.btn-danger'));
        }
        
        addPerson(processDiv);
    }
    
    // Add person to process
    function addPerson(processDiv) {
        const personContainer = processDiv.querySelector('.person-container');
        
        // Hide add button from previous last row
        const existingRows = personContainer.querySelectorAll('.person-row');
        if (existingRows.length > 0) {
            const lastRow = existingRows[existingRows.length - 1];
            const addButton = lastRow.querySelector('.btn-person-add');
            if (addButton) {
                addButton.style.visibility = 'hidden';
            }
        }
        
        const personDiv = document.createElement('div');
        personDiv.className = 'person-row';
        personDiv.innerHTML = `
            <input type="text" placeholder="ชื่อ" required onchange="calculateTotal()" oninput="calculateTotal()">
            <span>ชั่วโมง</span>
            <input type="number" class="person-hour" value="0" min="0" onchange="validateAndCalculate(this)" onkeypress="return isNumberKey(event)">
            <span>นาที</span>
            <input type="number" class="person-minute" value="0" min="0" max="59" onchange="validateAndCalculate(this)" onkeypress="return isNumberKey(event)">
            <span>ปริมาณงาน</span>
            <input type="number" class="quantity-input" value="1" min="1" onchange="validateAndCalculate(this)" onkeypress="return isNumberKey(event)">
            <span>หน่วย</span>
            <input type="text" class="unit-input" placeholder="เช่น ครั้ง, ชิ้น, สถานที่" required>
            <button class="btn btn-person-add" onclick="addPerson(this.closest('.process-section'))">เพิ่มคน</button>
            <button class="btn btn-person-delete" onclick="deletePerson(this)">ลบคน</button>
        `;
        
        personContainer.appendChild(personDiv);
    }
    
    // Delete process
    function deleteProcess(btn) {
        const taskDiv = btn.closest('.task-item');
        const processContainer = taskDiv.querySelector('.process-container');
        
        if (processContainer.children.length > 1) {
            if (confirm('ต้องการลบกระบวนการนี้ใช่หรือไม่?')) {
                const lastProcess = processContainer.lastElementChild;
                lastProcess.remove();
                calculateTotal();
                
                // Remove delete process button if only one process left
                if (processContainer.children.length === 1) {
                    const deleteProcessBtn = taskDiv.querySelector('.btn-delete-process');
                    if (deleteProcessBtn) {
                        deleteProcessBtn.remove();
                    }
                }
            }
        } else {
            alert('ต้องมีกระบวนการอย่างน้อย 1 กระบวนการ');
        }
    }
    
    // Delete person
    function deletePerson(btn) {
        const processDiv = btn.closest('.process-section');
        const personContainer = processDiv.querySelector('.person-container');
        const personRows = personContainer.querySelectorAll('.person-row');
        
        if (personRows.length > 1) {
            const currentRow = btn.closest('.person-row');
            const isLastRow = currentRow === personRows[personRows.length - 1];
            
            currentRow.remove();
            
            // If we deleted the last row, show add button on new last row
            if (isLastRow) {
                const newLastRow = personContainer.querySelector('.person-row:last-child');
                if (newLastRow) {
                    const addButton = newLastRow.querySelector('.btn-person-add');
                    if (addButton) {
                        addButton.style.visibility = 'visible';
                    }
                }
            }
            
            calculateTotal();
        } else {
            alert('ต้องมีบุคลากรอย่างน้อย 1 คน');
        }
    }
    
    // Calculate totals
    function calculateTotal() {
        let totalMinutes = 0;
        let personTotals = {};
        
        document.querySelectorAll('.task-item').forEach(task => {
            task.querySelectorAll('.process-section').forEach(process => {
                let processMinutes = 0;
                
                process.querySelectorAll('.person-row').forEach(person => {
                    const name = person.querySelector('input[type="text"]').value;
                    const hours = parseInt(person.querySelector('.person-hour').value) || 0;
                    const minutes = parseInt(person.querySelector('.person-minute').value) || 0;
                    const quantity = parseInt(person.querySelector('.quantity-input').value) || 1;
                    
                    const personMinutes = (hours * 60) + minutes;
                    const totalPersonMinutes = personMinutes * quantity;
                    
                    processMinutes += personMinutes; // Sum time is without quantity
                    
                    if (name && totalPersonMinutes > 0) {
                        if (!personTotals[name]) personTotals[name] = 0;
                        personTotals[name] += totalPersonMinutes;
                    }
                });
                
                // Update process time displays
                const sumHours = Math.floor(processMinutes / 60);
                const sumMinutes = processMinutes % 60;
                process.querySelector('.sum-time').textContent = `${sumHours} ชม. ${sumMinutes} นาที`;
                
                // Total time includes quantity multiplication
                let totalProcessMinutes = 0;
                process.querySelectorAll('.person-row').forEach(person => {
                    const hours = parseInt(person.querySelector('.person-hour').value) || 0;
                    const minutes = parseInt(person.querySelector('.person-minute').value) || 0;
                    const quantity = parseInt(person.querySelector('.quantity-input').value) || 1;
                    
                    const personMinutes = (hours * 60) + minutes;
                    totalProcessMinutes += personMinutes * quantity;
                });
                
                const totalHours = Math.floor(totalProcessMinutes / 60);
                const totalMins = totalProcessMinutes % 60;
                process.querySelector('.total-time').textContent = `${totalHours} ชม. ${totalMins} นาที`;
                
                totalMinutes += totalProcessMinutes;
            });
        });
        
        // Update total summary
        const totalDays = Math.floor(totalMinutes / 480);
        const totalRemaining = totalMinutes % 480;
        const totalHours = Math.floor(totalRemaining / 60);
        const totalMins = totalRemaining % 60;
        
        document.getElementById('total-summary-value').textContent = 
            `${totalDays} วันทำการ ${totalHours} ชม. ${totalMins} นาที`;
        
        // Update person summary
        const personSummary = document.getElementById('person-summary-content');
        personSummary.innerHTML = '';
        
        Object.keys(personTotals).forEach(name => {
            const minutes = personTotals[name];
            const days = Math.floor(minutes / 480);
            const remaining = minutes % 480;
            const hours = Math.floor(remaining / 60);
            const mins = remaining % 60;
            
            const div = document.createElement('div');
            div.className = 'person-summary-item';
            div.textContent = `${name}: ${days} วันทำการ ${hours} ชม. ${mins} นาที`;
            personSummary.appendChild(div);
        });
    }
    
    // Export to Excel
    function exportToExcel() {
        // Validate form before export
        if (!validateForm()) {
            alert('กรุณากรอกข้อมูลให้ครบถ้วนก่อนการ Export');
            return;
        }
        
        const data = [];
        
        // Get header info
        const department = document.getElementById('department').value;
        const job = document.getElementById('job').value;
        const informant = document.getElementById('informant').value;
        
        // Header
        data.push(["ฝ่าย", "งาน", "ผู้ให้ข้อมูล", "ลำดับ", "บทบาทหน้าที่ภารกิจหน่วยงาน", "สิ่งที่ส่งมอบ", "โครงการ/กิจกรรม", 
                   "กระบวนการ/ขั้นตอน", "บุคลากร", "ชั่วโมง", "นาที", "ปริมาณงาน", 
                   "หน่วยนับของปริมาณงาน", "เวลารวม/หน่วย", "เวลารวมของการทำกิจกรรม", "เวลารวมทั้งสิ้น"]);
        
        // Data rows
        document.querySelectorAll('.task-item').forEach((task, taskIndex) => {
            const taskNumber = taskIndex + 1;
            const role = task.querySelector('textarea[name="role"]').value;
            const deliverable = task.querySelector('textarea[name="deliverable"]').value;
            const project = task.querySelector('textarea[name="project"]').value;
            
            let isFirstRowOfTask = true;
            
            task.querySelectorAll('.process-section').forEach(process => {
                const processText = process.querySelector('textarea[name="process"]').value;
                const sumTime = process.querySelector('.sum-time').textContent;
                const totalTime = process.querySelector('.total-time').textContent;
                
                process.querySelectorAll('.person-row').forEach(person => {
                    const name = person.querySelector('input[type="text"]').value;
                    const hours = person.querySelector('.person-hour').value;
                    const minutes = person.querySelector('.person-minute').value;
                    const quantity = person.querySelector('.quantity-input').value;
                    const unit = person.querySelector('.unit-input').value;
                    
                    const totalSummary = isFirstRowOfTask ? document.getElementById('total-summary-value').textContent : '';
                    
                    data.push([
                        department,
                        job,
                        informant,
                        taskNumber,
                        role,
                        deliverable,
                        project,
                        processText,
                        name,
                        hours,
                        minutes,
                        quantity,
                        unit,
                        sumTime,
                        totalTime,
                        totalSummary
                    ]);
                    
                    isFirstRowOfTask = false;
                });
            });
        });
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Job Analysis");
        XLSX.writeFile(wb, "job_analysis.xlsx");
    }
    
    // Import from Excel
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                // Check if we have enough data
                if (jsonData.length < 2) {
                    alert('ไฟล์ Excel ไม่มีข้อมูลหรือรูปแบบไม่ถูกต้อง');
                    return;
                }
                
                // Set header information (from first data row)
                if (jsonData[1] && jsonData[1].length >= 3) {
                    document.getElementById('department').value = jsonData[1][0] || '';
                    document.getElementById('job').value = jsonData[1][1] || '';
                    document.getElementById('informant').value = jsonData[1][2] || '';
                }
                
                // Clear existing tasks
                document.getElementById('taskContainer').innerHTML = '';
                taskCount = 0;
                
                // Group data by task number
                const taskGroups = {};
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length < 13) continue; // Skip incomplete rows
                    
                    const taskNumber = row[3];
                    
                    if (!taskGroups[taskNumber]) {
                        taskGroups[taskNumber] = {
                            role: row[4],
                            deliverable: row[5],
                            project: row[6],
                            processes: {}
                        };
                    }
                    
                    const processText = row[7];
                    if (!taskGroups[taskNumber].processes[processText]) {
                        taskGroups[taskNumber].processes[processText] = [];
                    }
                    
                    taskGroups[taskNumber].processes[processText].push({
                        name: row[8],
                        hours: row[9],
                        minutes: row[10],
                        quantity: row[11],
                        unit: row[12]
                    });
                }
                
                // Create tasks
                Object.keys(taskGroups).forEach(taskNumber => {
                    const taskData = taskGroups[taskNumber];
                    addNewTask();
                    
                    const taskDiv = document.querySelector(`[data-task-id="${taskCount}"]`);
                    taskDiv.querySelector('textarea[name="role"]').value = taskData.role || '';
                    taskDiv.querySelector('textarea[name="deliverable"]').value = taskData.deliverable || '';
                    taskDiv.querySelector('textarea[name="project"]').value = taskData.project || '';
                    
                    // Clear default process
                    taskDiv.querySelector('.process-container').innerHTML = '';
                    
                    // Add processes
                    Object.keys(taskData.processes).forEach(processText => {
                        addProcess(taskDiv.querySelector('.btn-success'));
                        const processDiv = taskDiv.querySelector('.process-container').lastElementChild;
                        processDiv.querySelector('textarea[name="process"]').value = processText || '';
                        
                        // Clear default person
                        processDiv.querySelector('.person-container').innerHTML = '';
                        
                        // Add persons
                        taskData.processes[processText].forEach(personData => {
                            addPerson(processDiv);
                            const personRow = processDiv.querySelector('.person-container').lastElementChild;
                            personRow.querySelector('input[type="text"]').value = personData.name || '';
                            personRow.querySelector('.person-hour').value = personData.hours || 0;
                            personRow.querySelector('.person-minute').value = personData.minutes || 0;
                            personRow.querySelector('.quantity-input').value = personData.quantity || 1;
                            personRow.querySelector('.unit-input').value = personData.unit || '';
                        });
                    });
                });
                
                calculateTotal();
                alert('นำเข้าข้อมูลสำเร็จ');
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการนำเข้าข้อมูล: ' + error.message);
            }
        };
        
        reader.readAsArrayBuffer(file);
    });
    
    // Validate form fields
    function validateForm() {
        let isValid = true;
        let errorMessage = '';
        
        // Check header fields
        const department = document.getElementById('department').value;
        const job = document.getElementById('job').value;
        const informant = document.getElementById('informant').value;
        
        if (!department || !job || !informant) {
            errorMessage += 'กรุณากรอกข้อมูลฝ่าย งาน และผู้ให้ข้อมูลให้ครบถ้วน\n';
            isValid = false;
        }
        
        // Check task fields
        document.querySelectorAll('.task-item').forEach((task, index) => {
            const role = task.querySelector('textarea[name="role"]').value;
            const deliverable = task.querySelector('textarea[name="deliverable"]').value;
            const project = task.querySelector('textarea[name="project"]').value;
            
            if (!role || !deliverable || !project) {
                errorMessage += `ภารกิจที่ ${index + 1}: กรุณากรอกข้อมูลบทบาทหน้าที่ สิ่งที่ส่งมอบ และโครงการให้ครบถ้วน\n`;
                isValid = false;
            }
            
            task.querySelectorAll('.process-section').forEach((process, pIndex) => {
                const processText = process.querySelector('textarea[name="process"]').value;
                
                if (!processText) {
                    errorMessage += `ภารกิจที่ ${index + 1}, กระบวนการที่ ${pIndex + 1}: กรุณากรอกข้อมูลกระบวนการ\n`;
                    isValid = false;
                }
                
                process.querySelectorAll('.person-row').forEach((person, personIndex) => {
                    const name = person.querySelector('input[type="text"]').value;
                    const unit = person.querySelector('.unit-input').value;
                    
                    if (!name || !unit) {
                        errorMessage += `ภารกิจที่ ${index + 1}, กระบวนการที่ ${pIndex + 1}, บุคคลที่ ${personIndex + 1}: กรุณากรอกชื่อและหน่วยนับให้ครบถ้วน\n`;
                        isValid = false;
                    }
                });
            });
        });
        
        if (!isValid) {
            alert(errorMessage);
        }
        
        return isValid;
    }
    
    // Allow only numbers
    function isNumberKey(evt) {
        const charCode = (evt.which) ? evt.which : evt.keyCode;
        if (charCode > 31 && (charCode < 48 || charCode > 57)) {
            evt.preventDefault();
            return false;
        }
        return true;
    }
    
    // Validate and calculate
    function validateAndCalculate(input) {
        if (input.value < 0) {
            input.value = 0;
        }
        
        if (input.classList.contains('person-minute') && input.value > 59) {
            input.value = 59;
            alert('นาทีต้องไม่เกิน 59');
        }
        
        calculateTotal();
    }
    
    // Initial load
    window.onload = function() {
        addNewTask();
    };
    </script>
</body>
</html>
